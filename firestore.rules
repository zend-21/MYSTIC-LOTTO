rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── 사용자 개인 데이터 ──────────────────────────────
    // 본인만 읽기/쓰기 가능 (익명 포함 타 사용자 접근 불가)
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /archives/{archiveId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // ── 전역 로또 히스토리 ─────────────────────────────
    // 모든 로그인 사용자 읽기 가능, 쓰기는 불가 (관리자만 콘솔에서 수정)
    match /global/{docId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // ── 천상의 광장 (채팅방, 게시판) ──────────────────
    match /square/{docId} {
      allow read: if request.auth != null;

      // 방 목록
      match /rooms/list/{roomId} {
        // 방 생성: 로그인 사용자 가능
        allow create: if request.auth != null;
        // 방 삭제: 방 생성자(creatorId)만 가능
        allow delete: if request.auth != null
                      && request.auth.uid == resource.data.creatorId;
        // 방 업데이트 (참여자 수 등): 로그인 사용자 가능
        allow update: if request.auth != null;

        // 채팅 메시지: 로그인 사용자 읽기/쓰기, 본인 메시지만 삭제
        match /messages/{messageId} {
          allow read: if request.auth != null;
          allow create: if request.auth != null;
          allow delete: if request.auth != null
                        && request.auth.uid == resource.data.userId;
          allow update: if false;
        }
      }

      // 게시판
      match /board/posts/{postId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        // 게시글 수정/삭제: 작성자만 가능 (authorId 필드 기준)
        allow update, delete: if request.auth != null
                              && request.auth.uid == resource.data.authorId;
      }
    }
  }
}
