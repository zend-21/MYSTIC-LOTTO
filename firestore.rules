rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── 헬퍼 함수 ─────────────────────────────────────────────────
    function isLoggedIn() {
      return request.auth != null;
    }

    // 관리자 UID는 서버사이드 Rules에만 존재 — 클라이언트에 절대 노출 안 됨
    function isAdmin() {
      return isLoggedIn() && request.auth.uid == 'o5XegbLlnPVJhZtn31HXyddBGKW2';
    }

    // 요청이 특정 필드만 변경하는지 확인
    function onlyChanges(fields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(fields);
    }

    // ── 사용자 개인 데이터 ──────────────────────────────────────────
    match /users/{userId} {
      allow read, write: if isLoggedIn() && request.auth.uid == userId;

      match /archives/{archiveId} {
        allow read, write: if isLoggedIn() && request.auth.uid == userId;
      }

      // 선물 inbox: 누구나 보낼 수 있고, 본인만 읽기/삭제 가능
      match /inbox/{docId} {
        allow create: if isLoggedIn();
        allow read, delete: if isLoggedIn() && request.auth.uid == userId;
        allow update: if false;
      }
    }

    // ── 전역 로또 히스토리 ─────────────────────────────────────────
    match /global/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    // ── 관리자 설정 (부관리자 목록 등) ────────────────────────────
    match /config/{docId} {
      allow read: if isLoggedIn();
      allow write: if isAdmin();
    }

    // ── 고유 태그 역참조 ───────────────────────────────────────────
    match /userTags/{tag} {
      allow read: if isLoggedIn();
      // 생성/수정: 태그가 본인 uid를 가리킬 때만
      allow create: if isLoggedIn() && request.resource.data.uid == request.auth.uid;
      // 삭제: 본인 태그만
      allow delete: if isLoggedIn() && resource.data.uid == request.auth.uid;
      // 업데이트 불가 (태그는 한번 설정 후 변경 없음)
      allow update: if false;
    }

    // ── 천상의 광장 최상위 doc ──────────────────────────────────────
    match /square/{docId} {
      allow read: if isLoggedIn();
    }

    // ── 방 목록: square/rooms/list/{roomId} ────────────────────────
    match /square/rooms/list/{roomId} {
      allow read: if isLoggedIn();

      // 방 생성: 로그인 유저, 단 creatorId는 반드시 본인 uid
      allow create: if isLoggedIn()
                    && request.resource.data.creatorId == request.auth.uid;

      // 방 삭제: 방 개설자 또는 관리자
      allow delete: if isLoggedIn()
                    && (resource.data.creatorId == request.auth.uid || isAdmin());

      // 방 업데이트 — 필드별로 권한 분리
      allow update: if isLoggedIn() && (
        // ① 관리자 또는 방 개설자: 모든 필드 수정 가능
        (resource.data.creatorId == request.auth.uid || isAdmin())
        ||
        // ② 일반 유저: participantCount, lastEnteredAt 두 필드만 수정 가능
        //    (입퇴장 카운팅 및 방문 시각 갱신 목적)
        onlyChanges(['participantCount', 'lastEnteredAt'])
      );

      // ── 채팅 메시지 ──────────────────────────────────────────────
      match /messages/{messageId} {
        allow read: if isLoggedIn();

        // 메시지 생성: 본인 uid 또는 'system' (소멸 의식 알림 등)
        allow create: if isLoggedIn() && (
          request.resource.data.userId == request.auth.uid ||
          request.resource.data.userId == 'system'
        );

        // 메시지 수정: 불가 (채팅 무결성)
        allow update: if false;

        // 메시지 삭제: 본인 메시지만 (시스템 메시지는 삭제 불가)
        allow delete: if isLoggedIn()
                      && resource.data.userId == request.auth.uid;
      }
    }

    // ── 게시판: square/board/posts/{postId} ────────────────────────
    match /square/board/posts/{postId} {
      allow read: if isLoggedIn();

      // 게시글 작성: 로그인 유저
      allow create: if isLoggedIn();

      // 게시글 업데이트
      allow update: if isLoggedIn() && (
        // 관리자: 모든 수정 가능
        isAdmin()
        ||
        // 일반 유저: likes 필드만 증가 가능 (공명/좋아요)
        (onlyChanges(['likes']) && request.resource.data.likes == resource.data.likes + 1)
        ||
        // comments 배열 추가만 허용 (댓글 기능)
        onlyChanges(['comments'])
      );

      // 게시글 삭제: 관리자만 (모더레이션)
      allow delete: if isAdmin();
    }
  }
}
